CREATE OR REPLACE PROCEDURE ADD_INVENTORY(
    I_MAST_NAME IN VARCHAR2,
    I_MAST_QTY IN NUMERIC,
    I_MAST_DESC IN VARCHAR2,
    I_SECTOR_NAME IN VARCHAR2,
    I_PURCHASED_NIK IN VARCHAR2
)AS
V_MAST_NAME VARCHAR2(20) :=I_MAST_NAME;
V_MAST_QTY NUMERIC :=I_MAST_QTY;
V_MAST_DESC VARCHAR2(40) :=I_MAST_DESC;
QTYINSIDE REST_MAST_INVENTORY.QTY%TYPE;
V_ID REST_MAST_INVENTORY.ID%TYPE;

SECTORID REST_DETAIL_INFO.ID%TYPE;
PURCHASEDBY EMP_HR.ID%TYPE;
V_SECTOR_NAME VARCHAR(25):=I_SECTOR_NAME;
V_PURCHASED_NIK VARCHAR2(50) :=I_PURCHASED_NIK;
BEGIN
    SELECT QTY,ID INTO QTYINSIDE,V_ID FROM REST_MAST_INVENTORY WHERE REST_MAST_INVENTORY.NAME=V_MAST_NAME;
        UPDATE REST_MAST_INVENTORY
            SET QTY=QTYINSIDE+V_MAST_QTY
        WHERE REST_MAST_INVENTORY.NAME=V_MAST_NAME;
        
        SELECT ID INTO SECTORID FROM REST_DETAIL_INFO WHERE REST_DETAIL_INFO.SECTOR_NAME= V_SECTOR_NAME;
        SELECT ID INTO PURCHASEDBY FROM EMP_HR WHERE EMP_HR.NIK= V_PURCHASED_NIK;    
        
        ADD_INVENTORY2(QTYINSIDE+V_MAST_QTY,SECTORID,PURCHASEDBY,V_ID);
         
    EXCEPTION
        WHEN NO_DATA_FOUND
        THEN
        INSERT INTO REST_MAST_INVENTORY(NAME,QTY,INVT_DESC)VALUES (V_MAST_NAME,V_MAST_QTY,V_MAST_DESC);
        
        SELECT ID INTO SECTORID FROM REST_DETAIL_INFO WHERE REST_DETAIL_INFO.SECTOR_NAME= V_SECTOR_NAME;
        SELECT ID INTO PURCHASEDBY FROM EMP_HR WHERE EMP_HR.NIK= V_PURCHASED_NIK;
        SELECT ID INTO V_ID FROM REST_MAST_INVENTORY WHERE REST_MAST_INVENTORY.NAME=V_MAST_NAME;
        DBMS_OUTPUT.PUT_LINE(V_MAST_QTY||' '||V_ID );
        ADD_INVENTORY2(V_MAST_QTY,SECTORID,PURCHASEDBY,V_ID);
END;

CREATE OR REPLACE PROCEDURE ADD_INVENTORY2(
    QTYINSIDE IN NUMERIC,
    SECTORID IN NUMERIC,
    PURCHASEDBY IN NUMERIC,
    MAST_ID IN NUMERIC
)AS
V_QTYINSIDE NUMERIC :=QTYINSIDE;
V_SECTORID NUMERIC:=SECTORID;
V_PURCHASEDBY NUMERIC:=PURCHASEDBY;
V_ID NUMERIC:=MAST_ID;

L_COUNTER NUMERIC:=0;
AMOUNT_MAST_INVT_ID NUMERIC;
MAST_INVT_ID_TEMP NUMERIC;
A NUMERIC;
BEGIN
    SELECT MAST_INVT_ID INTO MAST_INVT_ID_TEMP
    FROM REST_DETAIL_INVENTORY 
    JOIN REST_MAST_INVENTORY
    ON REST_MAST_INVENTORY.ID=MAST_INVT_ID
    WHERE REST_MAST_INVENTORY.ID=V_ID
    GROUP BY REST_DETAIL_INVENTORY.MAST_INVT_ID;
        SELECT COUNT(MAST_INVT_ID) INTO AMOUNT_MAST_INVT_ID
            FROM REST_DETAIL_INVENTORY 
            JOIN REST_MAST_INVENTORY
            ON REST_MAST_INVENTORY.ID=MAST_INVT_ID
            WHERE REST_MAST_INVENTORY.ID=V_ID; 
            
        FOR A IN AMOUNT_MAST_INVT_ID+1 .. V_QTYINSIDE LOOP
            DBMS_OUTPUT.PUT_LINE('KESUKSESAN '||A||' '|| V_QTYINSIDE );
            INSERT INTO REST_DETAIL_INVENTORY(INVT_NAME,SECTOR_ID,STATUS,PURCHASED_AT,PURCHASED_BY,MAST_INVT_ID)
                SELECT DISTINCT REST_MAST_INVENTORY.NAME||' '||A,V_SECTORID,'NEW',SYSDATE,V_PURCHASEDBY,REST_MAST_INVENTORY.ID
                FROM REST_DETAIL_INVENTORY
                JOIN REST_MAST_INVENTORY
                ON MAST_INVT_ID=REST_MAST_INVENTORY.ID
                WHERE MAST_INVT_ID=V_ID;
            COMMIT;
        END LOOP;        
        
        EXCEPTION
            WHEN NO_DATA_FOUND
            THEN
            DBMS_OUTPUT.PUT_LINE('INI EXCEPTION '||V_QTYINSIDE||' '|| V_SECTORID || ' ' || V_PURCHASEDBY||' '||V_ID );
            LOOP
                L_COUNTER:=L_COUNTER+1;
                EXIT WHEN L_COUNTER>V_QTYINSIDE;
                INSERT INTO REST_DETAIL_INVENTORY(INVT_NAME,SECTOR_ID,STATUS,PURCHASED_AT,PURCHASED_BY,MAST_INVT_ID)
                    SELECT REST_MAST_INVENTORY.NAME||' '||L_COUNTER,V_SECTORID,'NEW',SYSDATE,V_PURCHASEDBY,REST_MAST_INVENTORY.ID
                    FROM REST_MAST_INVENTORY
                    WHERE REST_MAST_INVENTORY.ID=V_ID;
                COMMIT;
            END LOOP;
END;

EXECUTE ADD_INVENTORY('PANCI',5,'ALAT MASAK','BACK GARDEN','111111');
SELECT * FROM REST_MAST_INVENTORY;
SELECT * FROM REST_DETAIL_INVENTORY;
SELECT * FROM REST_DETAIL_INFO;
SELECT * FROM EMP_HR;

DROP TABLE CASHIER_POS_RECORD;
DROP SEQUENCE CASHIER_POS_RECORD_SEQ;

DROP TABLE CUST_ORDER_PAYMENT;
DROP SEQUENCE CUST_ORDER_PAYMENT_SEQ;

DROP TABLE CUST_DETAIL_ORDER;
DROP SEQUENCE CUST_DETAIL_ORDER_SEQ;

SELECT * FROM USER_CONSTRAINTS WHERE TABLE_NAME = 'REST_DETAIL_INVENTORY';

DROP TABLE REST_DETAIL_INVENTORY;
DROP SEQUENCE REST_DETAIL_INVENTORY_SEQ;

DROP TABLE REST_DETAIL_INVENTORY;
DROP SEQUENCE REST_DETAIL_INVENTORY_SEQ;

DROP TABLE REST_MAST_INVENTORY;
DROP SEQUENCE REST_MAST_INVENTORY_SEQ;